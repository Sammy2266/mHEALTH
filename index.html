<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mHealth App</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h1>mHealth App</h1>
    <div id="login-container">
        <div id="g_id_onload"
             data-client_id="69710847341-8ophvuic95s6v8kpa0amvp9a46k9t8su.apps.googleusercontent.com"
             data-callback="handleLoginSuccess">
        </div>
        <div class="g_id_signin" data-type="standard"></div>
    </div>
    
    <div id="content" style="display: none;">
        <h2>Welcome, <span id="user-name"></span></h2>
        <h3>Step Count (Last 7 Days)</h3>
        <canvas id="stepChart"></canvas>
    </div>

    <script>
        let accessToken = "";

        function handleLoginSuccess(response) {
            const credential = response.credential;
            accessToken = credential;
            document.getElementById("login-container").style.display = "none";
            document.getElementById("content").style.display = "block";
            fetchSteps();
        }

        async function fetchSteps() {
            const url = "https://www.googleapis.com/fitness/v1/users/me/dataset:aggregate";
            const body = {
                aggregateBy: [{ dataTypeName: "com.google.step_count.delta" }],
                bucketByTime: { durationMillis: 86400000 },
                startTimeMillis: Date.now() - 7 * 24 * 60 * 60 * 1000,
                endTimeMillis: Date.now(),
            };

            const response = await fetch(url, {
                method: "POST",
                headers: {
                    Authorization: `Bearer ${accessToken}`,
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(body),
            });

            const data = await response.json();
            if (data.bucket) {
                const labels = [];
                const steps = [];
                data.bucket.forEach(bucket => {
                    labels.push(new Date(parseInt(bucket.startTimeMillis)).toLocaleDateString());
                    steps.push(bucket.dataset[0].point[0]?.value[0]?.intVal || 0);
                });
                renderChart(labels, steps);
            }
        }

        function renderChart(labels, steps) {
            const ctx = document.getElementById("stepChart").getContext("2d");
            new Chart(ctx, {
                type: "line",
                data: {
                    labels: labels,
                    datasets: [{
                        label: "Steps",
                        data: steps,
                        borderColor: "#42A5F5",
                        fill: false
                    }]
                }
            });
        }
    </script>
</body>
</html>
